# 老師帳號密碼修改功能說明

## 功能概述

此功能允許通過 `add_user.php` 創建的老師使用者，在首次登入時可以修改系統自動生成的帳號和密碼。修改過帳號後，之後只能修改密碼，無法再次修改帳號。

## 設定步驟

### 1. 執行資料庫遷移腳本

首先需要執行 SQL 腳本來添加 `username_changed` 欄位：

```bash
# 方法 1: 使用 MySQL 命令列
mysql -u root -p topics_good < Topics-backend/scripts/add_username_changed_column.sql

# 方法 2: 在 MySQL 客戶端中執行
# 打開 MySQL 客戶端，連接到 topics_good 資料庫，然後執行：
source Topics-backend/scripts/add_username_changed_column.sql;
```

### 2. 確認欄位已添加

執行以下 SQL 查詢確認欄位已成功添加：

```sql
DESCRIBE user;
```

您應該會看到 `username_changed` 欄位，類型為 `TINYINT(1)`，預設值為 `0`。

## 功能說明

### 系統生成的帳號識別

系統會自動識別通過 `add_user.php` 創建的帳號，這些帳號具有以下特徵：
- 帳號名稱以 `user_`、`staff_` 或 `admin_` 開頭
- `username_changed` 欄位為 `0`（未修改過）

### 首次登入時

當老師使用者首次登入並進入 `teacher_profile.php` 頁面時：
- 會顯示「帳號密碼設定」區塊
- 可以同時修改帳號和密碼
- 系統會提示這是系統生成的帳號，建議立即修改

### 修改過帳號後

一旦使用者修改過帳號：
- `username_changed` 欄位會被設為 `1`
- 之後只能修改密碼，無法再次修改帳號
- 系統會顯示提示訊息：「您已經修改過帳號，現在只能修改密碼」

## API 端點

### POST /teacher/update-credentials

更新老師的帳號和/或密碼。

**請求參數：**
- `old_username` (必填): 當前帳號
- `current_password` (必填): 當前密碼（用於驗證身份）
- `new_password` (必填): 新密碼
- `new_username` (選填): 新帳號（僅在尚未修改過帳號時可用）

**回應：**
- 成功：`{"message": "帳號和密碼更新成功", "new_username": "新帳號"}`
- 失敗：`{"message": "錯誤訊息"}`

**錯誤碼：**
- `400`: 缺少必要參數
- `401`: 當前密碼錯誤
- `403`: 帳號只能修改一次，已經修改過
- `409`: 新帳號已被使用
- `500`: 伺服器錯誤

## 安全考量

1. **密碼驗證**：修改帳號或密碼前，必須輸入當前密碼進行驗證
2. **帳號唯一性**：系統會檢查新帳號是否已被使用
3. **一次性修改**：帳號只能修改一次，防止頻繁變更
4. **密碼雜湊**：新密碼會使用 bcrypt 進行雜湊處理（PHP 兼容格式）

## 注意事項

1. 修改帳號後，使用者需要使用新帳號重新登入
2. 系統會自動登出使用者，提示使用新帳號登入
3. 如果 `username_changed` 欄位不存在，系統會自動判斷為未修改狀態（預設值為 0）
4. 只有通過 `add_user.php` 創建的帳號（具有特定前綴）才會顯示帳號密碼修改功能

## 測試建議

1. 使用 `add_user.php` 創建一個新的老師帳號
2. 使用系統生成的帳號和密碼登入
3. 進入個人資料頁面，確認可以看到帳號密碼修改區塊
4. 修改帳號和密碼，確認更新成功
5. 再次進入個人資料頁面，確認只能修改密碼，無法修改帳號

